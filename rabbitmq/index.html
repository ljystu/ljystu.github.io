<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title class="pjax-title">RabbbitMQ - My New Hugo Site</title><meta name="Description" content="这是我的全新 Hugo 网站"><meta property="og:title" content="RabbbitMQ" />
<meta property="og:description" content="Decoupling Event-driven design better performance Problems with Synchronous communication(Feign): 1.Coupling 2.can not handle huge amount of requests in a short time(high concurrency). 3.Waste of resources during waiting 4.Cascade failure: service failed, the cluster fails cascadingly Asynchronous(Event driven design): Use Broker to control events. Service publish events and the others subscribed to the broker waiting for events. Better performance/No cascade failures Advantages of asynchronous communication: Low coupling Improve throughput Fault isolation" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/rabbitmq/" /><meta property="og:image" content="http://example.org/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-10T11:13:32+01:00" />
<meta property="article:modified_time" content="2022-08-10T11:13:32+01:00" /><meta property="og:site_name" content="My New Hugo Site" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://example.org/logo.png"/>

<meta name="twitter:title" content="RabbbitMQ"/>
<meta name="twitter:description" content="Decoupling Event-driven design better performance Problems with Synchronous communication(Feign): 1.Coupling 2.can not handle huge amount of requests in a short time(high concurrency). 3.Waste of resources during waiting 4.Cascade failure: service failed, the cluster fails cascadingly Asynchronous(Event driven design): Use Broker to control events. Service publish events and the others subscribed to the broker waiting for events. Better performance/No cascade failures Advantages of asynchronous communication: Low coupling Improve throughput Fault isolation"/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="http://example.org/rabbitmq/" /><link rel="prev" href="http://example.org/redis-distributed-lock/" /><link rel="next" href="http://example.org/elasticsearch/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/fontawesome-free/all.min.css">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/animate/animate.min.css">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "RabbbitMQ",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/example.org\/rabbitmq\/"
        },"genre": "posts","wordcount":  1344 ,
        "url": "http:\/\/example.org\/rabbitmq\/","datePublished": "2022-08-10T11:13:32+01:00","dateModified": "2022-08-10T11:13:32+01:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Jingyu Li"
            },"description": ""
    }
    </script></head>

<body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme);}
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' || theme === 'black' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('auto' === 'light' || 'auto' === 'dark' || 'auto' === 'black') setTheme('auto'), saveTheme('auto'); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627','black': '#000000'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="My New Hugo Site">Personal Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/projects/"> Projects </a><span class="menu-item delimiter"></span><a href="#" onclick="return false;" class="menu-item language" title="Select Language">English<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" title="Select Language" id="language-select-desktop" onchange="location = this.value;"><option value="/rabbitmq/" selected>English</option></select>
                    </a><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="#" onclick="return false;" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" onclick="return false;" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="#" onclick="return false;" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="My New Hugo Site">Personal Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="#" onclick="return false;" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" onclick="return false;" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="#" onclick="return false;" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/projects/" title="">Projects</a><a href="#" onclick="return false;" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a><a href="#" onclick="return false;" class="menu-item" title="Select Language">English<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" title="Select Language" onchange="location = this.value;"><option value="/rabbitmq/" selected>English</option></select>
                </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><div class="toc" id="toc-auto">
        <h2 class="toc-title">Contents</h2>
        <div class="toc-content" id="toc-content-auto"></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle", "normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "false")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">RabbbitMQ</h1><div class="post-meta">
            <div class="post-meta-line">
                <span class="post-author"><i class="author fas fa-user-circle fa-fw"></i><a href="/" title="Author" rel=" author" class="author">Jingyu Li</a>
                </span>&nbsp;<span class="post-category">included in </span>&nbsp;<span class="post-category">category <a href="/categories/tech/"><i class="far fa-folder fa-fw"></i>Tech</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-08-10">2022-08-10</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime="2022-08-10">2022-08-10</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1344 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;3 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="true">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#problems-with-synchronous-communicationfeign">Problems with Synchronous communication(Feign):</a></li>
        <li><a href="#asynchronousevent-driven-design">Asynchronous(Event driven design):</a></li>
        <li><a href="#rabbitmq">Rabbitmq</a></li>
        <li><a href="#spring-amqp">Spring amqp</a></li>
        <li><a href="#topicexchange">TopicExchange</a></li>
        <li><a href="#reliability">Reliability</a>
          <ul>
            <li><a href="#publisher-confirm">publisher confirm:</a></li>
            <li><a href="#publisher-return">publisher-return:</a></li>
            <li><a href="#consumer-ack">Consumer Ack:</a></li>
            <li><a href="#ttl">TTL:</a>
              <ul>
                <li><a href="#dlx-dead-letter-exchange">DLX dead letter exchange</a></li>
              </ul>
            </li>
            <li><a href="#dead-letter-queue-summary">Dead letter queue summary:</a></li>
            <li><a href="#dead-letter-queue-use-case">Dead letter queue use case</a></li>
            <li><a href="#use-plugin-to-create-delayqueue">Use plugin to create delayqueue.</a>
              <ul>
                <li><a href="#install">Install:</a></li>
                <li><a href="#use">Use:</a></li>
              </ul>
            </li>
            <li><a href="#message-stuck">Message stuck</a></li>
            <li><a href="#lazy-queues">Lazy Queues</a></li>
          </ul>
        </li>
        <li><a href="#mq-cluster">MQ cluster</a>
          <ul>
            <li><a href="#classic-cluster">classic cluster</a></li>
            <li><a href="#image-cluster">Image cluster</a></li>
            <li><a href="#quorum-queues">Quorum Queues</a></li>
          </ul>
        </li>
        <li><a href="#typical-problems-of-rabbitmq">Typical problems of RabbitMQ</a>
          <ul>
            <li><a href="#duplicate-consumption-of-messages">Duplicate consumption of messages</a>
              <ul>
                <li><a href="#make-sure-the-consumer-only-executes-it-once">Make sure the consumer only executes it once</a></li>
                <li><a href="#use-the-unique-key-in-database">Use the unique key in database</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#publish-faster-than-consumestuck-in-the-queue">Publish faster than consume(Stuck in the queue)</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><ol>
<li>Decoupling</li>
<li>Event-driven design</li>
<li>better performance</li>
</ol>
<h3 id="problems-with-synchronous-communicationfeign">Problems with Synchronous communication(Feign):</h3>
<p>1.Coupling
2.can not handle huge amount of requests in a short time(high concurrency).
3.Waste of resources during waiting
4.Cascade failure: service failed, the cluster fails cascadingly</p>
<h3 id="asynchronousevent-driven-design">Asynchronous(Event driven design):</h3>
<p>Use Broker to control events. Service publish events and the others subscribed to the broker waiting for events.</p>
<p>Better performance/No cascade failures
<strong>Advantages of asynchronous communication:</strong></p>
<ol>
<li>Low coupling</li>
<li>Improve throughput</li>
<li>Fault isolation</li>
<li>Flow peaking</li>
</ol>
<p><strong>Disadvantages of asynchronous communication:</strong></p>
<ol>
<li>Rely on Broker&rsquo;s reliability, security and throughput</li>
<li>The architecture is complicated, the business does not have an obvious process line, which is not easy to track and manage.</li>
</ol>
<h3 id="rabbitmq">Rabbitmq</h3>
<p><img
        class="lazyload"
        data-src="/Rabbitmq/rabbitmq1.png"
        data-srcset="/Rabbitmq/rabbitmq1.png, /Rabbitmq/rabbitmq1.png 1.5x, /Rabbitmq/rabbitmq1.png 2x"
        data-sizes="auto"
        alt="/Rabbitmq/rabbitmq1.png"
        title="Screenshot 2022-07-13 at 21.22.33.png"
    />
<strong>Message sending process for basic message queue:</strong></p>
<ol>
<li>Establish a connection</li>
<li>Create a channel</li>
<li>Declare queues using created channels</li>
<li>Use channel to send messages to queues</li>
</ol>
<p><strong>Message receiving process for basic message queue:</strong></p>
<ol>
<li>Establish a connection</li>
<li>Create a channel</li>
<li>Use the channel to declare the queue</li>
<li>Declare consumer method handleDelivery()</li>
<li>Use channel to bind consumers to queues</li>
</ol>
<h3 id="spring-amqp">Spring amqp</h3>
<p>Use rabbitTemplate to send and get messages
<img
        class="lazyload"
        data-src="/Rabbitmq/rabbitmq2.png"
        data-srcset="/Rabbitmq/rabbitmq2.png, /Rabbitmq/rabbitmq2.png 1.5x, /Rabbitmq/rabbitmq2.png 2x"
        data-sizes="auto"
        alt="/Rabbitmq/rabbitmq2.png"
        title="Screenshot 2022-07-15 at 19.00.54.png"
    /></p>
<p>queues can use same binding key(which makes them fanout exchange)
<img
        class="lazyload"
        data-src="/Rabbitmq/rabbitmq3.png"
        data-srcset="/Rabbitmq/rabbitmq3.png, /Rabbitmq/rabbitmq3.png 1.5x, /Rabbitmq/rabbitmq3.png 2x"
        data-sizes="auto"
        alt="/Rabbitmq/rabbitmq3.png"
        title="Screenshot 2022-07-15 at 20.15.08.png"
    />
<img
        class="lazyload"
        data-src="/Rabbitmq/rabbitmq4.png"
        data-srcset="/Rabbitmq/rabbitmq4.png, /Rabbitmq/rabbitmq4.png 1.5x, /Rabbitmq/rabbitmq4.png 2x"
        data-sizes="auto"
        alt="/Rabbitmq/rabbitmq4.png"
        title="Screenshot 2022-07-15 at 20.23.21.png"
    />
Describe the difference between Direct switch and Fanout switch?
Fanout: routes messages to every queue bound to it.
Direct: Determines Which Queue It Is Routed To According To RouteKey.
• If multiple queues have the same RoutingKey, it is similar to Fanout function.
The common annotations based on @RabbitListener annotation declaration queues and switches:
@Queue
@Exchange</p>
<h3 id="topicexchange">TopicExchange</h3>
<p><img
        class="lazyload"
        data-src="/Rabbitmq/rabbitmq5.png"
        data-srcset="/Rabbitmq/rabbitmq5.png, /Rabbitmq/rabbitmq5.png 1.5x, /Rabbitmq/rabbitmq5.png 2x"
        data-sizes="auto"
        alt="/Rabbitmq/rabbitmq5.png"
        title="Screenshot 2022-07-15 at 20.27.51.png"
    /></p>
<p>In message queues, any object will be serialized. But the performance of the default serialization method(JDK serialization) is not really satisfying(takes too much space).
We can use Jackson converter to improve its performance.
Note: Some bugs may appear while using Jackson converter./
<img
        class="lazyload"
        data-src="/Rabbitmq/rabbitmq6.png"
        data-srcset="/Rabbitmq/rabbitmq6.png, /Rabbitmq/rabbitmq6.png 1.5x, /Rabbitmq/rabbitmq6.png 2x"
        data-sizes="auto"
        alt="/Rabbitmq/rabbitmq6.png"
        title="Screenshot 2022-07-15 at 20.40.59.png"
    />
<img
        class="lazyload"
        data-src="/Rabbitmq/rabbitmq7.png"
        data-srcset="/Rabbitmq/rabbitmq7.png, /Rabbitmq/rabbitmq7.png 1.5x, /Rabbitmq/rabbitmq7.png 2x"
        data-sizes="auto"
        alt="/Rabbitmq/rabbitmq7.png"
        title="Screenshot 2022-07-15 at 20.47.07.png"
    /><strong>Note: consumer and publisher must be using the same message converter.</strong></p>
<h3 id="reliability">Reliability</h3>
<h4 id="publisher-confirm">publisher confirm:</h4>
<blockquote>
<p>publisher-confirm-type = correlate</p>
</blockquote>
<p>Enabling publisher confirms calls back a confirm function to identify whether the process succeeds.
<strong>(Producer to exchange)</strong>
<strong>true: ack</strong>
<strong>false: nack</strong>
To define callback:</p>
<blockquote>
<p>rabbitTemplate.setConfirmCallback() confirm as an anonymous class method
confirm(CorrelationData, ack, cause)
ack: whether the exchange have received the message
correlationData: info can be manually set (id)</p>
</blockquote>
<h4 id="publisher-return">publisher-return:</h4>
<p>exchange to queue: if failed return &ldquo;return Callback&rdquo;</p>
<blockquote>
<p>publisher-returns: true
template:
mandatory: true</p>
</blockquote>
<p>When the <strong>message from the exchange did not get to the queue</strong>, the default mode is throwing the message away, but we can change the mode of returnCallback notify the publisher of the failure.</p>
<blockquote>
<p>rabbbitTemplate.returnsCallback()
default mode: discard message, not returning  <br>
the returnedMessage method deals with messages in the exchange but not sent to the queues.</p>
</blockquote>
<h4 id="consumer-ack">Consumer Ack:</h4>
<blockquote>
<p>acknowledge = none</p>
</blockquote>
<p>As soon as the consumer receives the message, it send the ack message (No service successfulness confirmation)</p>
<blockquote>
<p>acknowledge = &ldquo;manual&rdquo;</p>
</blockquote>
<p>Manually use channel.basicAck() to confirm and channel.basicNack() to let the publisher resend the message.</p>
<blockquote>
<p>auto</p>
</blockquote>
<p><img
        class="lazyload"
        data-src="/Rabbitmq/rabbitmq8.png"
        data-srcset="/Rabbitmq/rabbitmq8.png, /Rabbitmq/rabbitmq8.png 1.5x, /Rabbitmq/rabbitmq8.png 2x"
        data-sizes="auto"
        alt="/Rabbitmq/rabbitmq8.png"
        title="Screenshot 2022-07-22 at 15.51.16.png"
    />
Use republishMessageRecover to bind error message and its routing key.
How to guarantee reliability？</p>
<ol>
<li>Enbale publisher confirms and publisher returns to ensure message is sent to the exchange and queues</li>
<li>Enable durability to ensure messages are durable</li>
<li>Use consumer ack to ensure the consumer gets messages from queues</li>
<li>Set acknowlwdge-mode to auto or simply use republishMessageRecoverer to bind error message queue and exchange.</li>
</ol>
<p>flow control ：</p>
<ol>
<li>use manual ack mode</li>
<li>listener-container  prefetch = 1000 to control the flow. (The consumer get 1000 messages every time, need manual confirmation to continue)</li>
</ol>
<h4 id="ttl">TTL:</h4>
<p>time to live: before the message got discarded.</p>
<blockquote>
<p>x-message-tt</p>
</blockquote>
<ol>
<li>queue ttl can be set in the confiogurations.(Delete all messages in the queue) ms</li>
<li>message ttl need to implement messagePostProcessor to setExpiration in the message properties(When the expired message is on top of the queue, it will be deleted.)</li>
</ol>
<p>Setting queue ttl and message ttl at the same time, it will use the shorter one.</p>
<h5 id="dlx-dead-letter-exchange">DLX dead letter exchange</h5>
<p>When a message is dead, it can be sent to another exchange. It is called DLX.</p>
<p><img
        class="lazyload"
        data-src="/Rabbitmq/rabbitmq9.png"
        data-srcset="/Rabbitmq/rabbitmq9.png, /Rabbitmq/rabbitmq9.png 1.5x, /Rabbitmq/rabbitmq9.png 2x"
        data-sizes="auto"
        alt="/Rabbitmq/rabbitmq9.png"
        title="Screenshot 2022-07-18 at 16.58.47.png"
    /></p>
<h4 id="dead-letter-queue-summary">Dead letter queue summary:</h4>
<ol>
<li>There is no difference between dead letter switches and dead letter queues and Xitong.</li>
<li>When the message becomes a dead letter, if the queue is bound to a dead letter switch, the message will be rerouted to the dead letter team by the dead letter switch.</li>
<li>Messages become dead letter:
<ol>
<li>exceeded limit of the queue</li>
<li>consumer refused(basicNack) and requeue = false</li>
<li>queue expired/message expired</li>
</ol>
</li>
</ol>
<p>parameters: x-dead-letter-exchange and x-dead-letter-routing-key</p>
<h4 id="dead-letter-queue-use-case">Dead letter queue use case</h4>
<p>In the shopping cart case, users place their order and need to pay within 15 min or so.
In this case, the message TTL can be set to 15 min(in order.delay.queue). After that, the messages will be sent to dead letter queue(order.release.queue) and the overtime order cancel can be realized.</p>
<blockquote>
<p>@Bean public Queue orderDelayQueue(){
HashMap&lt;String, Object&gt; args = new HashMap&lt;&gt;();
args.put(&ldquo;x-dead-letter-exchange&rdquo;,&ldquo;order-event-exchange&rdquo;);
args.put(&ldquo;x-dead-letter-routing-key&rdquo;,&ldquo;order.release.order&rdquo;);
args.put(&ldquo;x-message-ttl&rdquo;,60000);
return new Queue(&ldquo;order.delay.queue&rdquo;, true, false, false, args);
}
@Bean public Binding stockReleaseBinding(){
return new Binding(&ldquo;order.release.order.queue&rdquo;,
Binding.DestinationType.QUEUE,
&ldquo;order-event-exchange&rdquo;,
&ldquo;order.release.order&rdquo;, null);
}</p>
</blockquote>
<h4 id="use-plugin-to-create-delayqueue">Use plugin to create delayqueue.</h4>
<h5 id="install">Install:</h5>
<h5 id="use">Use:</h5>
<p>In the listener, declare delayed = true in th exchange setting.
In the publisher, set message property: .setHeader(&ldquo;x-delay&rdquo;, 5000)
The message will be delayed, but the publisher returns will get errors for not able to send the message directly to the exchange. In the message, the ReceivedDelay property will be the x-delay we set. So one possible solution would be using conditional statement to skip the publisher return</p>
<blockquote>
<p>if (message.getMessageProperties().getReceivedDelay() &gt; 0) {
return;
}</p>
</blockquote>
<h4 id="message-stuck">Message stuck</h4>
<p>solutions:</p>
<ol>
<li>more consumers</li>
<li>thread pool</li>
<li>increase volume of the queue</li>
</ol>
<h4 id="lazy-queues">Lazy Queues</h4>
<p>Note that normal rabbitmq queues are stored in the memory.
But the lazy queues directly store the messages in the disk(This will cause some performance issues). When the consumers are consuming messages, the messages are read from the disk into the memory.(This supports millions of messages storing.)
To set one queue to be lazy queue, simply set x-queue-mode to &ldquo;lazy&rdquo; or @arguments = @Argument(name = &ldquo;x-queue-mode&rdquo;, value = &ldquo;lazy&rdquo;)
Pro:</p>
<ol>
<li>higher upper limit(disk storage)</li>
<li>no intermittent page-out more stable</li>
</ol>
<p>Con:</p>
<ol>
<li>longer delay</li>
<li>Subject to the disk IO performance</li>
</ol>
<h3 id="mq-cluster">MQ cluster</h3>
<h4 id="classic-cluster">classic cluster</h4>
<p>Nodes in the cluster share some info like exchange queue but not messages in the queues.
If one node is offline, the messages are lost.
When the consumer are requesting info from one node but the visited node doesn&rsquo;t have the queue. It will get the queue and its info from the node that has it.</p>
<h4 id="image-cluster">Image cluster</h4>
<ol>
<li>The image queue structure is one <strong>master and multiple slave</strong> (slave is an image)</li>
<li>all operations are performed on the primary node and then synchronized to the image node.</li>
<li>After the master node is down, the image node is replaced by a new master node (if the master node is down before the master-slave synchronization is completed, data loss may occur)</li>
<li>the server load balancer function is not available because all operations are completed by the master node (but the master node of different queues can be different, which can be used to improve throughput)</li>
</ol>
<p>higher reliability</p>
<h4 id="quorum-queues">Quorum Queues</h4>
<p>Sane as image queues but easier to use.<a href="https://www.yuque.com/attachments/yuque/0/2022/md/26679661/1658677394941-258ac0d0-38e4-4f0a-b932-5c7bfa757bfc.md?_lake_card=%7B%22src%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2022%2Fmd%2F26679661%2F1658677394941-258ac0d0-38e4-4f0a-b932-5c7bfa757bfc.md%22%2C%22name%22%3A%22RabbitMQ%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97.md%22%2C%22size%22%3A16675%2C%22type%22%3A%22text%2Fmarkdown%22%2C%22ext%22%3A%22md%22%2C%22source%22%3A%22%22%2C%22status%22%3A%22done%22%2C%22mode%22%3A%22title%22%2C%22download%22%3Atrue%2C%22taskId%22%3A%22u4ca91ba1-163a-4433-8746-0abc37864c0%22%2C%22taskType%22%3A%22upload%22%2C%22__spacing%22%3A%22both%22%2C%22id%22%3A%22u0013e100%22%2C%22margin%22%3A%7B%22top%22%3Atrue%2C%22bottom%22%3Atrue%7D%2C%22card%22%3A%22file%22%7D" target="_blank" rel="noopener noreffer">RabbitMQ部署指南.md</a></p>
<h3 id="typical-problems-of-rabbitmq">Typical problems of RabbitMQ</h3>
<h4 id="duplicate-consumption-of-messages">Duplicate consumption of messages</h4>
<p>To solve this problem, first we need to make sure there&rsquo;s an unique identifier for each of the messages.</p>
<h5 id="make-sure-the-consumer-only-executes-it-once">Make sure the consumer only executes it once</h5>
<p>Use redis to store unique identifier, when sending the message, determine whether the identifier already exists in Redis.</p>
<blockquote>
<p>Boolean flag = stringRedisTemplate.opsForValue().setIfAbsent(&ldquo;orderNo+couponId&rdquo;);
Check whether the message has already been consumed
if (! Boolean.TRUE.equals(flag)) { return; } // Execute business&hellip; / / consumer identity stored in Redis, expired stringRedisTemplate for 10 SEC opsForValue (). The set (&quot; orderNo + couponId &ldquo;, &ldquo;1&rdquo;, Duration, ofSeconds (10 l));</p>
</blockquote>
<h5 id="use-the-unique-key-in-database">Use the unique key in database</h5>
<p>We can also use an unique key in the database to ensure its consistency when executed multiple times.</p>
<h3 id="publish-faster-than-consumestuck-in-the-queue">Publish faster than consume(Stuck in the queue)</h3>
<ul>
<li>Throttling the producer&rsquo;s message sending interface (not recommended, affecting user experience)</li>
<li>deploy more consumer instances (recommended)</li>
<li>increase the number of prefetch to allow the consumer to receive more messages at a time (recommended, can be used together with the second solution)</li>
</ul>
</div>

        <div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2022-08-10</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/rabbitmq/index.md" target="_blank" rel="noopener noreferrer">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="#" onclick="return false;" title="Share on Twitter" data-sharer="twitter" data-url="http://example.org/rabbitmq/" data-title="RabbbitMQ"><i class="fab fa-twitter fa-fw"></i></a><a href="#" onclick="return false;" title="Share on Facebook" data-sharer="facebook" data-url="http://example.org/rabbitmq/"><i class="fab fa-facebook-square fa-fw"></i></a><a href="#" onclick="return false;" title="Share on WhatsApp" data-sharer="whatsapp" data-url="http://example.org/rabbitmq/" data-title="RabbbitMQ" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href="#" onclick="return false;" title="Share on Line" data-sharer="line" data-url="http://example.org/rabbitmq/" data-title="RabbbitMQ"><i data-svg-src="/lib/simple-icons/icons/line.min.svg"></i></a><a href="#" onclick="return false;" title="Share on 微博" data-sharer="weibo" data-url="http://example.org/rabbitmq/" data-title="RabbbitMQ"><i class="fab fa-weibo fa-fw"></i></a><a href="#" onclick="return false;" title="Share on Myspace" data-sharer="myspace" data-url="http://example.org/rabbitmq/" data-title="RabbbitMQ" data-description=""><i data-svg-src="/lib/simple-icons/icons/myspace.min.svg"></i></a><a href="#" onclick="return false;" title="Share on Blogger" data-sharer="blogger" data-url="http://example.org/rabbitmq/" data-title="RabbbitMQ" data-description=""><i class="fab fa-blogger fa-fw"></i></a><a href="#" onclick="return false;" title="Share on Evernote" data-sharer="evernote" data-url="http://example.org/rabbitmq/" data-title="RabbbitMQ"><i class="fab fa-evernote fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/redis-distributed-lock/" class="prev" rel="prev" title="Redis distributed lock"><i class="fas fa-angle-left fa-fw"></i>Redis distributed lock</a>
            <a href="/elasticsearch/" class="next" rel="next" title="Elasticssearch">Elasticssearch<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"></div></article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.98.0">Hugo</a> | Theme - <a href="https://github.com/HEIGE-PCloud/DoIt" target="_blank" rel="noopener noreffer" title="DoIt 0.2.13"><i class="far fa-edit fa-fw"></i> DoIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank" rel="noopener noreferrer">Jingyu Li</a></span></div>
        </div></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="Back to Top">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
            <i class="fas fa-comment fa-fw"></i>
        </a>
    </div><div id="cookieconsent-container"></div><div class="assets"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript" src="/lib/topbar/topbar.min.js"></script><script type="text/javascript" src="/lib/pjax/pjax.min.js"></script><script type="text/javascript" src="/js/theme.min.js"></script></div>

<div class="pjax-assets"><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":50,"type":"lunr"},"sharerjs":true};</script><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/katex/katex.min.css">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/katex/copy-tex.min.css">
    <noscript><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"></noscript></div>
</body>

</html>